<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Atsuzaki&#x27;s site - Rusty (Mis)adventures #1: Postgres (and all sorts of) enums in Diesel</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
     

      
          <link rel="stylesheet" href="https://atsuzaki.com/site.css">
     

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">atsuzaki</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="mailto:kphilip@pdx.edu">
                            kphilip@pdx.edu
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.com&#x2F;atsuzaki&#x2F;">
                            GitHub
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <nav class="menu">
                    <div class="logo"><a href="https:&#x2F;&#x2F;atsuzaki.com&#x2F;">atsuzaki</a></div>
                    <ul>
                        
                            <li>
                                <a href="mailto:kphilip@pdx.edu">
                                    kphilip@pdx.edu
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.com&#x2F;atsuzaki&#x2F;">
                                    GitHub
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;atsuzaki.com&#x2F;blog&#x2F;diesel-enums&#x2F;">Rusty (Mis)adventures #1: Postgres (and all sorts of) enums in Diesel</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-08-05</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>Once upon a time, a Postgres user who loves their enums encountered this error while trying to compile a freshly-generated Diesel schema.rs:</p>
<pre><code>error[E0412]: cannot find type `User_role` in this scope
  --&gt; src&#x2F;schema.rs:27:17
   |
27 |         role -&gt; User_role,
   |                 ^^^^^^^^^ not found in this scope

</code></pre>
<p>Some googling landed me on <a href="https://github.com/diesel-rs/diesel/issues/343">this issue</a>, revealing that Postgres enums are unsupported and that I should roll a <a href="https://github.com/diesel-rs/diesel/blob/adc6db3f74eedaa34a0694759cccc29b95ada052/diesel_tests/tests/custom_types.rs">custom SQL types</a> instead--a boilerplatey but reasonable way to map custom database types to Rust types.</p>
<p>Even better, there's already a neat <a href="https://github.com/adwhit/diesel-derive-enum/">diesel-derive-enum</a> crate that nicely generates the impls for you. All you need is to <code>#[derive(DbEnum)]</code> and you're all set. How to use this crate with Diesel autogenerated migrations was not too obvious from its READMEs and examples though.</p>
<p>Theres two key information to get this to work:</p>
<ol>
<li>Diesel-cli's <code>import_types</code> field</li>
<li>Diesel-derive-enum's <a href="https://github.com/adwhit/diesel-derive-enum/blob/master/tests/src/rename.rs">renaming capabilites</a></li>
</ol>
<p>Given that we have this nice little enum in <code>sql_types.rs</code>:</p>
<pre data-lang="rust" class="language-rust "><code class="language-rust" data-lang="rust">&#x2F;&#x2F; In sql_types.rs
#[derive(DbEnum)]
 pub enum UserRole {
     Admin,
     Employee,
 }
</code></pre>
<p>And we add the <code>import_types</code> field in <code>diesel.toml</code>: </p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># In diesel.toml

[print_schema]
file = &quot;src&#x2F;schema.rs&quot;
import_types = [&quot;diesel::sql_types::*&quot;, &quot;crate::sql_types::*&quot;]
</code></pre>
<p>...Diesel will then generate use statements for every table you're defining with the <code>table!</code> macro. Run <code>diesel migration run</code> (it doesn't recognize the changes unless you run it, for me) and now Diesel can recognize our enums! </p>
<p>......or not?</p>
<pre><code>error[E0412]: cannot find type `User_role` in this scope
  --&gt; src&#x2F;schema.rs:36:17
   |
36 |         role -&gt; User_role,
   |                 ^^^^^^^^^ not found in this scope

</code></pre>
<p>So, it turns out that for type <code>my_enum</code> in Postgres, diesel-derive-enums will generate the Diesel type <code>MyEnumMapping</code>. <em>Meanwhile</em>, Diesel's autogenerated schema.rs will name it <code>My_enum</code>, so the names obviously don't match! </p>
<p>Diesel-derive-enums provides handy attributes to rename the generated type, both on the Diesel and Postgres side with <code>#[DieselType = &quot;Renamed_Enum&quot;]</code> and <code>#[PgType = &quot;Another_Renamed_Enum&quot;]</code>, respectively. We don't need a rename on the postgres side now, so lets slap the Diesel rename on.</p>
<p>Additionally, Diesel seems to wants the struct to derive from <code>Debug + PartialEq</code> in order for it to work with print schema, so let's also add that.</p>
<p>Which gives us this working, neatly-decorated enum:</p>
<pre data-lang="rust" class="language-rust "><code class="language-rust" data-lang="rust">&#x2F;&#x2F; In sql_types.rs

#[derive(Debug, PartialEq, DbEnum)]
#[DieselType = &quot;User_role&quot;]
 pub enum UserRole {
     Admin,
     Employee,
 }
</code></pre>
<p>Yay!</p>
<p>And so, our application runs happily ever after. The end. </p>
<hr />
<p><em>I started this series documenting my Rust (mis)adventures--digging through git issues, layers of code, gitter channels, heap of test suites, etc--in hopes that it'll help someone out there.</em></p>
<p><em>Please shoot me a DM/email if you notice any mistakes, or would like to throw in additional tips!</em> </p>

    </div>

    
    

    <div class="post-footer">
        
            
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://atsuzaki.com/even.js" ></script>
      
    </body>

</html>
